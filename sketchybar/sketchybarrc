#!/bin/bash

# This is the main SketchyBar configuration file
# Place this file at ~/.config/sketchybar/sketchybarrc
# Make it executable: chmod +x ~/.config/sketchybar/sketchybarrc

source "$CONFIG_DIR/colors.sh" # Loads all defined colors
source "$CONFIG_DIR/icons.sh" # Loads all defined icons

ITEM_DIR="$CONFIG_DIR/items" # Directory where the items are configured
PLUGIN_DIR="$CONFIG_DIR/plugins" # Directory where all the plugin scripts are stored

##### Bar Appearance #####
sketchybar --bar height=38 \
           blur_radius=30 \
           position=top \
           sticky=off \
           padding_left=8 \
           padding_right=8 \
           color=0x00000000 \
           corner_radius=12 \
           margin=8

##### Changing Defaults #####
# We now change some default values that are applied to all further items
# For a full list of all available item properties see:
# https://felixkratz.github.io/SketchyBar/config/items

default=(
  padding_left=8
  padding_right=8
  icon.font="JetBrainsMono Nerd Font:Bold:14.0"
  label.font="JetBrainsMono Nerd Font:Medium:14.0"
  icon.color=$ORANGE
  label.color=$ORANGE
  icon.padding_left=8
  icon.padding_right=0
  label.padding_left=4
  label.padding_right=8
  background.color=$ITEM_BG_COLOR
  background.corner_radius=8
  background.height=30
)

sketchybar --default "${default[@]}"

##### Adding AeroSpace Workspace Indicators #####
# Adding AeroSpace workspaces

# Add aerospace event
sketchybar --add event aerospace_workspace_change

# Initialize workspace items for all available workspaces (1-9)
# They will be shown/hidden dynamically based on app presence
for sid in {1..9}; do
  sketchybar --add item space.$sid left \
    --set space.$sid \
    drawing=off \
    background.corner_radius=6 \
    background.drawing=on \
    background.height=26 \
    background.padding_right=4 \
    background.padding_left=4 \
    icon="$sid" \
    icon.color=$WORKSPACE_INACTIVE_TEXT \
    icon.font="JetBrainsMono Nerd Font:Bold:14.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label="○" \
    label.font="JetBrainsMono Nerd Font:Bold:16.0" \
    label.color=$WORKSPACE_INACTIVE_TEXT \
    label.padding_right=8 \
    label.padding_left=4 \
    background.color=$WORKSPACE_INACTIVE_BG \
    background.border_width=0 \
    click_script="aerospace workspace $sid" \
    script="$CONFIG_DIR/plugins/aerospace.sh $sid" \
    --subscribe space.$sid mouse.entered mouse.exited
done

# Dynamic workspace manager - handles showing/hiding workspaces
sketchybar --add item workspace_manager left \
  --set workspace_manager \
  drawing=off \
  script="$PLUGIN_DIR/dynamic_workspaces.sh" \
  --subscribe workspace_manager aerospace_workspace_change

# Front app display
sketchybar --add item front_app left \
           --set front_app \
           icon.drawing=on \
           background.padding_left=4 \
           background.padding_right=8 \
           label.color=$ORANGE \
           label.font="JetBrainsMono Nerd Font:Medium:14.0" \
           script="$PLUGIN_DIR/aerospace_front_app.sh" \
           --subscribe front_app aerospace_workspace_change

##### Adding Center Items #####
sketchybar --add item clock center \
           --set clock update_freq=1 \
           icon="" \
           script="$PLUGIN_DIR/clock.sh" \
           click_script="open -a Calendar"

##### Adding Right Items #####
# Right items in reverse order for proper display (rightmost first): power, battery, memory, cpu, brightness, volume
sketchybar --add item power right \
           --set power icon="⏻" \
           icon.font="JetBrainsMono Nerd Font:Bold:16.0" \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           click_script="$PLUGIN_DIR/powermenu.sh" \
           --subscribe power mouse.entered mouse.exited

sketchybar --add item battery_internal right \
           --set battery_internal script="$PLUGIN_DIR/battery_internal.sh" \
           update_freq=120 \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           --subscribe battery_internal system_woke power_source_change \
           --subscribe battery_internal mouse.entered mouse.exited

sketchybar --add item memory right \
           --set memory update_freq=30 \
           icon="MEM" \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           script="$PLUGIN_DIR/memory.sh" \
           click_script="open -a 'Activity Monitor'" \
           --subscribe memory mouse.entered mouse.exited

sketchybar --add item cpu right \
           --set cpu update_freq=1 \
           icon="CPU" \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           script="$PLUGIN_DIR/cpu.sh" \
           click_script="open -a 'Activity Monitor'" \
           --subscribe cpu mouse.entered mouse.exited

sketchybar --add item brightness right \
           --set brightness script="$PLUGIN_DIR/brightness.sh" \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           update_freq=1 \
           --subscribe brightness mouse.entered mouse.exited

sketchybar --add item volume right \
           --set volume script="$PLUGIN_DIR/volume.sh" \
           background.drawing=off \
           background.padding_left=8 \
           background.padding_right=8 \
           click_script="open -a 'Audio MIDI Setup'" \
           --subscribe volume volume_change \
           --subscribe volume mouse.entered mouse.exited

# Using a bracket for the right side for consistent rounding and background.
sketchybar --add bracket right_bracket volume brightness cpu memory battery_internal power \
           --set right_bracket background.color=$ITEM_BG_COLOR \
           background.corner_radius=8 \
           background.height=30

##### Groups #####
sketchybar --add bracket spaces '/space\..*/' \
  --set spaces background.color=$ITEM_BG_COLOR \
  background.corner_radius=8 \
  background.height=30 \
  background.padding_left=2 \
  background.padding_right=2

##### Finalizing Setup #####
# The below command is only needed at the end of the initial configuration to
# force all scripts to run the first time.

sketchybar --update
